rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.role == 'super_admin';
    }

    function isTenantMember(tenantId) {
      return isAuthenticated() && request.auth.token.tenant_id == tenantId;
    }

    function isTenantAdmin(tenantId) {
      return isTenantMember(tenantId) &&
             request.auth.token.role == 'tenant_admin';
    }

    function isTenantStaffAdmin(tenantId) {
      return isTenantMember(tenantId) &&
             (request.auth.token.role == 'tenant_admin' ||
              request.auth.token.role == 'staff_admin');
    }

    function isTenantStaff(tenantId) {
      return isTenantMember(tenantId) &&
             (request.auth.token.role == 'tenant_admin' ||
              request.auth.token.role == 'staff_admin' ||
              request.auth.token.role == 'staff');
    }

    // ─── Tenants ────────────────────────────────────────────────────────────
    match /tenants/{tenantId} {
      allow read: if isSuperAdmin() || isTenantMember(tenantId);
      allow create: if isSuperAdmin();
      allow update, delete: if isSuperAdmin() || isTenantAdmin(tenantId);

      // ─── Chores — staff_admin+ can write ──────────────────────────────────
      match /chores/{choreId} {
        allow read: if isSuperAdmin() || isTenantMember(tenantId);
        allow create, update, delete: if isSuperAdmin() || isTenantStaffAdmin(tenantId);
      }

      // ─── Incidents — staff can report, staff_admin+ can update/close ──────
      match /incidents/{incidentId} {
        allow read: if isSuperAdmin() || isTenantMember(tenantId);
        allow create: if isSuperAdmin() || isTenantStaff(tenantId);
        allow update: if isSuperAdmin() || isTenantStaffAdmin(tenantId);
        allow delete: if isSuperAdmin(); // incidents are permanent audit records
      }

      // ─── Rides — any tenant member can request, staff_admin+ can assign ───
      match /rides/{rideId} {
        allow read: if isSuperAdmin() || isTenantMember(tenantId);
        allow create: if isSuperAdmin() || isTenantMember(tenantId);
        allow update: if isSuperAdmin() || isTenantStaffAdmin(tenantId) ||
                        (isTenantMember(tenantId) &&
                         resource.data.requestedBy == request.auth.uid);
        allow delete: if isSuperAdmin();
      }

      // ─── All other tenant subcollections (houses, staff, events, vehicles, enrollments)
      match /{document=**} {
        allow read: if isSuperAdmin() || isTenantMember(tenantId);
        allow write: if isSuperAdmin() || isTenantStaffAdmin(tenantId);
      }
    }

    // ─── Residents (global — not tenant-scoped) ──────────────────────────────
    // Residents can exist independently and move between tenants.
    // Any authenticated tenant member can read resident records.
    // Only staff_admin+ can create/update residents.
    match /residents/{residentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                      (request.auth.token.role == 'tenant_admin' ||
                       request.auth.token.role == 'staff_admin' ||
                       request.auth.token.role == 'super_admin');
      allow update: if isAuthenticated() &&
                      (request.auth.token.role == 'tenant_admin' ||
                       request.auth.token.role == 'staff_admin' ||
                       request.auth.token.role == 'super_admin');
      allow delete: if isSuperAdmin();

      // Personal resident events (appointments, drug tests, etc.)
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() &&
                        (request.auth.token.role == 'tenant_admin' ||
                         request.auth.token.role == 'staff_admin' ||
                         request.auth.token.role == 'staff' ||
                         request.auth.token.role == 'super_admin');
        allow update: if isAuthenticated() &&
                        (request.auth.token.role == 'tenant_admin' ||
                         request.auth.token.role == 'staff_admin' ||
                         request.auth.token.role == 'super_admin');
        allow delete: if isSuperAdmin();
      }
    }

    // ─── App Users (mobile) ──────────────────────────────────────────────────
    match /users/{uid} {
      allow read: if isAuthenticated() && request.auth.uid == uid;
      allow create: if isAuthenticated() && request.auth.uid == uid;
      allow update: if isAuthenticated() && request.auth.uid == uid;
      allow delete: if isSuperAdmin();
    }

    // ─── Join Requests (resident applying to join a tenant) ──────────────────
    match /tenants/{tenantId}/joinRequests/{uid} {
      allow read: if isSuperAdmin() || isTenantStaffAdmin(tenantId);
      allow create: if isAuthenticated() && request.auth.uid == uid;
      allow update: if isSuperAdmin() || isTenantStaffAdmin(tenantId);
      allow delete: if isSuperAdmin() || isTenantStaffAdmin(tenantId);
    }

    // Conversations (AI chat) - fixed CREATE rule (use request.resource for new docs)
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }

    // ─── Global LMS Courses ──────────────────────────────────────────────────
    // Courses can be public for all, or restricted to a specific tenant
    match /courses/{courseId} {
      allow read: if isAuthenticated() && (
        resource.data.isPublic == true ||
        resource.data.ownerTenantId == 'system' ||
        isTenantMember(resource.data.ownerTenantId)
      );
      allow create: if isSuperAdmin() || isTenantStaffAdmin(request.resource.data.ownerTenantId);
      allow update, delete: if isSuperAdmin() || isTenantStaffAdmin(resource.data.ownerTenantId);
      
      // Subcollections inside courses
      match /{document=**} {
         allow read: if isAuthenticated() && (
            get(/databases/$(database)/documents/courses/$(courseId)).data.isPublic == true ||
            get(/databases/$(database)/documents/courses/$(courseId)).data.ownerTenantId == 'system' ||
            isTenantMember(get(/databases/$(database)/documents/courses/$(courseId)).data.ownerTenantId)
         );
         allow write: if isSuperAdmin() || isTenantStaffAdmin(get(/databases/$(database)/documents/courses/$(courseId)).data.ownerTenantId);
      }
    }

    // ─── Gamification ────────────────────────────────────────────────────────
    // Global Leaderboard and Tenant Leaderboards
    match /gamification/{boardId} {
      // Anyone authenticated can read global or their tenant's points
      allow read: if isAuthenticated();
      
      // Points should only be incremented by secure Cloud Functions (or SuperAdmin)
      // We block client-side updates to prevent cheating
      allow write: if isSuperAdmin();
      
      match /profiles/{uid} {
         allow read: if isAuthenticated();
         // Clients cannot manually update their score
         allow write: if isSuperAdmin();
      }
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
